# Copyright Â© 2018 VMware, Inc. All Rights Reserved.
# SPDX-License-Identifier: BSD-2-Clause

# ---
# tasks file for roles/vappvm

- name: create vapp vm "{{ vapp_vm_1 }}" from catalog
  no_log: False
  vcd_vapp_vm:
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    source_catalog_name: "test_catalog"
    source_template_name: "centos7"
    source_vm_name: "CentOS7"
    hostname: "vcdcell"
    vmpassword: "rootpass" 
    vmpassword_auto: "false"
    vmpassword_reset: "false"
    ip_allocation_mode: "DHCP"
    state: "present"
    power_on: "false"
    all_eulas_accepted: "true"
    storage_profile: "{ \"name\" : \"Performance\",\"enabled\"  : true, \"units\" : \"MB\", \"limit\" : 0, \"default\" : true }"
    network: "web2Network"
  register: output

- name: create vapp output
  debug:
    msg: "{{ output }}"

- name: create vapp vm "{{ vapp_vm_2 }}" from vapp
  no_log: False
  vcd_vapp_vm:
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    source_vapp: "web"
    source_vm_name: "web1" 
    hostname: "vcdcell"
    vmpassword: "rootpass" 
    vmpassword_auto: "false"
    vmpassword_reset: "false"
    ip_allocation_mode: "DHCP"
    state: "present"
    power_on: "false"
    all_eulas_accepted: "true"
    # storage_profile: "Standard"
    network: "web2Network"
  register: output

- name: create vapp output
  debug:
    msg: "{{ output }}"

- name: power on "{{ vapp_vm_1 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "poweron"
  register: output

- name: power on vapp output
  debug:
    msg: "{{ output }}"

- name: power on "{{ vapp_vm_2 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "poweron"
  register: output

- name: power on vapp output
  debug:
    msg: "{{ output }}"

- name: power off "{{ vapp_vm_1 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "poweroff"
  register: output

- name: power off vapp output
  debug:
    msg: "{{ output }}"

- name: power off "{{ vapp_vm_2 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "poweroff"
  register: output

- name: power off vapp output
  debug:
    msg: "{{ output }}"

- name: modify "{{ vapp_vm_1 }}" cpu vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    virtual_cpus: 2
    cores_per_socket: 2
    state: "update"
  register: output

- name: update vapp output
  debug:
    msg: "{{ output }}"

- name: modify "{{ vapp_vm_2 }}" cpu vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    virtual_cpus: 2
    cores_per_socket: 2
    state: "update"
  register: output

- name: update vapp output
  debug:
    msg: "{{ output }}"

- name: modify "{{ vapp_vm_1 }}" memory vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    memory: 4096
    state: "update"
  register: output

- name: update vapp output
  debug:
    msg: "{{ output }}"

- name: modify "{{ vapp_vm_2 }}" memory vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    memory: 4096
    state: "update"
  register: output

- name: update vapp output
  debug:
    msg: "{{ output }}"

- name: reload "{{ vapp_vm_1 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "reloadvm"
  register: output

- name: reload vapp output
  debug:
    msg: "{{ output }}"

- name: reload "{{ vapp_vm_2 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "reloadvm"
  register: output

- name: reload vapp output
  debug:
    msg: "{{ output }}"

- name: undeploy "{{ vapp_vm_1 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "undeploy"
  register: output

- name: undeploy vapp output
  debug:
    msg: "{{ output }}"

- name: undeploy "{{ vapp_vm_2 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "undeploy"
  register: output

- name: undeploy vapp output
  debug:
    msg: "{{ output }}"

- name: deploy "{{ vapp_vm_1 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "deploy"
  register: output

- name: deploy vapp output
  debug:
    msg: "{{ output }}"

- name: deploy "{{ vapp_vm_2 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    operation: "deploy"
  register: output

- name: deploy vapp output
  debug:
    msg: "{{ output }}"

- name: delete "{{ vapp_vm_1 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_1 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    state: "absent"
  register: output

- name: delete vapp output
  debug:
    msg: "{{ output }}"

- name: delete "{{ vapp_vm_2 }}" vapp vm
  vcd_vapp_vm:
    source_vapp: "web2"
    target_vm_name: "{{ vapp_vm_2 }}"
    target_vapp: "web2"
    source_vdc: "Terraform_VDC"
    target_vdc: "Terraform_VDC"
    state: "absent"
  register: output

- name: delete vapp output
  debug:
    msg: "{{ output }}"